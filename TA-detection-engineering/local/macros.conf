[behavior_classify]
definition = eval behavior_class=case(\
    match(CommandLine,"(?i)invoke-mimikatz|sekurlsa|lsass"), "credential_access",\
    match(CommandLine,"(?i)schtasks"), "persistence",\
    match(CommandLine,"(?i)wevtutil|clear-eventlog"), "defense_evasion",\
    match(CommandLine,"(?i)whoami|net user|net group|nltest|net localgroup"), "discovery",\
    match(CommandLine,"(?i)net use.*\\\\\\\\.*\\$|\\\\\\\\.*\\\\(C|ADMIN|IPC)\\$"), "lateral_movement",\
    match(Image,"(?i)net\\.exe|net1\\.exe") AND match(CommandLine,"(?i)user|group|localgroup"), "discovery",\
    match(TargetObject,"(?i)\\\\CurrentVersion\\\\Run"), "persistence",\
    match(Image,"(?i)powershell\\.exe|cmd\\.exe"), "execution",\
    true(), "unknown"\
)
iseval = 0

[execution_context_classify]
definition = eval execution_context=case(\
    match(Image,"(?i)powershell\\.exe"), "powershell",\
    match(CommandLine,"(?i)comsvcs\\.dll.*MiniDump"), "lsass_dump_native",\
    match(CommandLine,"(?i)procdump.*lsass"), "lsass_dump_tool",\
    match(TargetObject,"(?i)\\\\CurrentVersion\\\\Run"), "registry_runkey",\
    match(Image,"(?i)schtasks\\.exe"), "scheduled_task",\
    match(CommandLine,"(?i)net use.*\\\\\\\\"), "network_share",\
    match(Image,"(?i)cmd\\.exe|net\\.exe|net1\\.exe|whoami\\.exe|nltest\\.exe|wevtutil\\.exe"), "command_line_tool",\
    true(), "other"\
)
iseval = 0

[behavior_route]
definition = lookup escu_detection_selector behavior_class execution_context OUTPUT escu_detection\
| lookup escu_detection_mitre_map escu_detection OUTPUT mitre_attack\
| eval mitre_techniques=split(mitre_attack,"|")\
| mvexpand mitre_techniques\
| eval mitre_parent=if(match(mitre_techniques,"\\."),\
                       mvindex(split(mitre_techniques,"."),0),\
                       mitre_techniques)\
| lookup mitre_enrichment mitre_id AS mitre_parent OUTPUTNEW tactics technique
iseval = 0
